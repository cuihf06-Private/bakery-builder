name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.5'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android SDK components
      run: |
        sdkmanager "build-tools;33.0.2" "platforms;android-33"

    - name: Install Cordova
      run: |
        npm install -g cordova@12

    - name: Create Cordova project structure
      run: |
        # 创建必要的目录结构
        mkdir -p www
        mkdir -p platforms
        mkdir -p plugins

        # 复制 HTML 文件到 www 目录
        cp index_save.html www/

        # 如果有其他资源文件也复制过去
        if [ -f "index.html" ]; then
          cp index.html www/
        fi

        # 创建默认图标（如果不存在）
        if [ ! -f "icon.png" ]; then
          # 创建一个简单的 1x1 透明 PNG 作为占位符
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > icon.png
        fi
        cp icon.png www/ 2>/dev/null || true

    - name: Add Android platform
      run: |
        cordova platform add android@12.0.0

    - name: Build APK
      run: |
        cordova build android --release -- --packageType=apk

    - name: Find APK file
      id: find_apk
      run: |
        APK_PATH=$(find platforms/android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK at: $APK_PATH"

    - name: Rename APK
      run: |
        APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" bakery-builder-v1.0.0.apk
          ls -lh bakery-builder-v1.0.0.apk
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: bakery-builder-apk
        path: bakery-builder-v1.0.0.apk

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-${{ github.run_number }}
        name: Release v1.0.0-${{ github.run_number }}
        body: |
          ## 面包工坊极速版 APK

          自动构建的 Android APK 文件

          ### 安装说明
          1. 下载 APK 文件
          2. 在 Android 设备上启用"未知来源"安装
          3. 安装 APK

          构建时间: ${{ github.event.head_commit.timestamp }}
        files: bakery-builder-v1.0.0.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
