<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ é¢åŒ…å·¥åŠæé€Ÿç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* å“åº”å¼æ ¹å­—ä½“å¤§å° - åŸºäºè§†å£å®½åº¦ */
    html {
      font-size: calc(14px + 0.4vw);
    }

    @media (max-width: 768px) {
      html {
        font-size: calc(12px + 0.5vw);
      }
    }

    @media (min-width: 1920px) {
      html {
        font-size: 20px;
      }
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #F5DEB3 0%, #DEB887 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .header {
      background: #8B4513;
      color: white;
      padding: 0.6rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0.12rem 0.6rem rgba(0,0,0,0.3);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .header-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      font-weight: bold;
    }

    .header-item span {
      font-size: 1.5rem;
    }

    .timer {
      background: #D2691E;
      padding: 0.3rem 0.9rem;
      border-radius: 1.2rem;
      font-size: 1.2rem;
    }
    
    /* ä¸»æ¸¸æˆåŒº */
    #game {
      display: flex;
      height: calc(100vh - 4rem);
      padding: 0.6rem;
      gap: 0.6rem;
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    /* å››æ å¸ƒå±€ - å§‹ç»ˆæ¨ªå‘æ’åˆ— */
    .field, .kitchen, .market, .shop {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 0.9rem;
      padding: 0.9rem;
      box-shadow: 0 0.25rem 0.9rem rgba(0,0,0,0.1);
      overflow-y: auto;
      flex: 1;
      min-width: 200px;
    }

    .section-title {
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      color: #8B4513;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 0.12rem solid #DEB887;
    }
    
    /* å†œç”°åŒº */
    .seeds-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      background: #FFF8DC;
      border-radius: 0.6rem;
    }

    .seed-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.3rem 0.6rem;
      background: white;
      border-radius: 1.2rem;
      border: 0.12rem solid #DEB887;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
    }

    .seed-item:hover {
      transform: scale(1.05);
      border-color: #8B4513;
    }

    .seed-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .seed-item.selected {
      background: #F5DEB3;
      border-color: #8B4513;
      box-shadow: 0 0 0.5rem rgba(139, 69, 19, 0.4);
    }

    .seed-item .unlimited {
      font-size: 0.6rem;
      color: #2E8B57;
      font-weight: bold;
    }

    .farm-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .farm-plot {
      aspect-ratio: 1;
      background: #D2691E;
      border-radius: 0.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 0.18rem solid transparent;
      position: relative;
      overflow: hidden;
    }

    .farm-plot:hover {
      transform: scale(1.02);
      border-color: #8B4513;
    }

    .farm-plot.planted {
      background: #8B4513;
    }

    .farm-plot.ready {
      animation: blink 1s infinite;
      border-color: #FFD700;
    }

    @keyframes blink {
      0%, 100% { box-shadow: 0 0 0.6rem #FFD700; }
      50% { box-shadow: 0 0 1.5rem #FFD700; }
    }

    .crop-icon {
      font-size: 2rem;
      margin-bottom: 0.2rem;
    }

    .progress-bar {
      width: 80%;
      height: 0.3rem;
      background: rgba(255,255,255,0.3);
      border-radius: 0.18rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #90EE90;
      border-radius: 0.18rem;
      transition: width 0.3s;
    }

    .plot-status {
      font-size: 0.6rem;
      color: white;
      margin-top: 0.12rem;
    }
    
    /* åˆ¶ä½œåŒº */
    .inventory-box {
      background: #FFF8DC;
      border-radius: 0.6rem;
      padding: 0.6rem;
      margin-bottom: 0.75rem;
      min-height: 4.2rem;
    }

    .inventory-title {
      font-size: 0.8rem;
      color: #8B4513;
      margin-bottom: 0.4rem;
      font-weight: bold;
    }

    .inventory-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .inv-item {
      width: 2.6rem;
      height: 2.6rem;
      background: white;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      border: 0.12rem solid #DEB887;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .inv-item:hover {
      transform: scale(1.1);
      border-color: #8B4513;
    }

    .inv-item.selected {
      background: #F5DEB3;
      border-color: #8B4513;
      box-shadow: 0 0 0.5rem rgba(139, 69, 19, 0.5);
    }

    .inv-item .count {
      position: absolute;
      bottom: 0.06rem;
      right: 0.06rem;
      background: #8B4513;
      color: white;
      font-size: 0.55rem;
      padding: 0.06rem 0.25rem;
      border-radius: 0.5rem;
    }

    .recipes-box {
      background: #FFF8DC;
      border-radius: 0.6rem;
      padding: 0.6rem;
      margin-bottom: 0.75rem;
    }

    .recipe-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem;
      margin-bottom: 0.4rem;
      background: white;
      border-radius: 0.5rem;
      border: 0.12rem solid #DEB887;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
    }

    .recipe-item:hover {
      border-color: #8B4513;
      transform: translateX(0.18rem);
    }

    .recipe-item.can-craft {
      border-color: #90EE90;
      background: #F0FFF0;
    }

    .recipe-ingredients {
      display: flex;
      gap: 0.18rem;
    }

    .recipe-ing {
      font-size: 1rem;
    }

    .recipe-arrow {
      font-size: 1rem;
      color: #8B4513;
    }

    .recipe-result {
      font-size: 1.4rem;
      margin-left: auto;
    }

    .recipe-time {
      font-size: 0.6rem;
      color: #666;
    }

    .crafting-queue {
      background: #FFF8DC;
      border-radius: 0.6rem;
      padding: 0.6rem;
    }

    .crafting-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem;
      margin-bottom: 0.4rem;
      background: white;
      border-radius: 0.5rem;
    }

    .crafting-progress {
      flex: 1;
      height: 0.4rem;
      background: #eee;
      border-radius: 0.18rem;
      overflow: hidden;
    }

    .crafting-fill {
      height: 100%;
      background: linear-gradient(90deg, #F5DEB3, #8B4513);
      border-radius: 0.18rem;
      transition: width 0.3s;
    }
    
    /* å¸‚åœºåŒº */
    .market-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .market-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem;
      background: white;
      border-radius: 0.6rem;
      border: 0.12rem solid #DEB887;
      transition: all 0.3s;
    }

    .market-item:hover {
      border-color: #8B4513;
      transform: translateX(0.18rem);
    }

    .market-item-icon {
      font-size: 2rem;
      width: 2.8rem;
      height: 2.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #F5DEB3;
      border-radius: 0.5rem;
    }

    .market-item-info {
      flex: 1;
    }

    .market-item-name {
      font-weight: bold;
      color: #8B4513;
      font-size: 0.85rem;
    }

    .market-item-desc {
      font-size: 0.7rem;
      color: #666;
    }

    .market-btn {
      padding: 0.4rem 0.75rem;
      background: #90EE90;
      border: none;
      border-radius: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.75rem;
      color: #2E8B57;
      transition: all 0.3s;
    }

    .market-btn:hover {
      background: #7FDD7F;
      transform: scale(1.05);
    }

    .market-btn:disabled {
      background: #ccc;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }
    
    /* å”®å–åŒº */
    .counter-box {
      background: #FFF8DC;
      border-radius: 0.6rem;
      padding: 0.6rem;
      margin-bottom: 0.75rem;
      min-height: 5rem;
    }

    .counter-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .counter-item {
      width: 3.1rem;
      height: 3.1rem;
      background: white;
      border-radius: 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 0.12rem solid #DEB887;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .counter-item:hover {
      transform: scale(1.05);
      border-color: #8B4513;
    }

    .counter-item.selected {
      background: #F5DEB3;
      border-color: #8B4513;
      box-shadow: 0 0 0.6rem rgba(139, 69, 19, 0.5);
    }

    .counter-item .bread-icon {
      font-size: 1.6rem;
    }

    .counter-item .bread-price {
      font-size: 0.55rem;
      color: #8B4513;
      font-weight: bold;
    }

    .counter-item .count {
      position: absolute;
      top: 0.06rem;
      right: 0.06rem;
      background: #8B4513;
      color: white;
      font-size: 0.55rem;
      padding: 0.06rem 0.25rem;
      border-radius: 0.5rem;
    }

    .customers-box {
      background: #FFF8DC;
      border-radius: 0.6rem;
      padding: 0.6rem;
    }

    .customer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 0.6rem;
      border: 0.12rem solid #DEB887;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .customer-avatar {
      font-size: 2rem;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #F5DEB3;
      border-radius: 50%;
    }

    .customer-info {
      flex: 1;
    }

    .customer-name {
      font-weight: bold;
      color: #8B4513;
      font-size: 0.75rem;
    }

    .customer-want {
      font-size: 0.7rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.18rem;
    }

    .customer-want-emoji {
      font-size: 1.1rem;
    }

    .customer-btn {
      padding: 0.4rem 0.75rem;
      background: #90EE90;
      border: none;
      border-radius: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.75rem;
      color: #2E8B57;
      transition: all 0.3s;
    }

    .customer-btn:hover {
      background: #7FDD7F;
      transform: scale(1.05);
    }

    .customer-btn:disabled {
      background: #ccc;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }
    
    /* å¼¹çª— */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      padding: 1rem;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 1.2rem;
      padding: 1.5rem;
      max-width: 31rem;
      width: 90%;
      text-align: center;
      transform: scale(0.8);
      transition: all 0.3s;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-title {
      font-size: 1.5rem;
      color: #8B4513;
      margin-bottom: 0.9rem;
    }

    .modal-content {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.9rem;
    }

    .modal-stats {
      background: #FFF8DC;
      border-radius: 0.9rem;
      padding: 0.9rem;
      margin-bottom: 0.9rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 0.06rem solid #DEB887;
      font-size: 0.85rem;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .modal-btn {
      padding: 0.75rem 2.2rem;
      background: #8B4513;
      color: white;
      border: none;
      border-radius: 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .modal-btn:hover {
      background: #A0522D;
      transform: scale(1.05);
    }
    
    /* å‡çº§å•†åº— */
    .upgrade-shop {
      margin-top: 0.9rem;
    }

    .upgrade-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      background: #FFF8DC;
      border-radius: 0.6rem;
      border: 0.12rem solid #DEB887;
    }

    .upgrade-icon {
      font-size: 1.9rem;
    }

    .upgrade-info {
      flex: 1;
      text-align: left;
    }

    .upgrade-name {
      font-weight: bold;
      color: #8B4513;
      font-size: 0.85rem;
    }

    .upgrade-desc {
      font-size: 0.75rem;
      color: #666;
    }

    .upgrade-btn {
      padding: 0.4rem 0.9rem;
      background: #90EE90;
      border: none;
      border-radius: 0.9rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.75rem;
      transition: all 0.3s;
    }

    .upgrade-btn:hover {
      background: #7FDD7F;
    }

    .upgrade-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* æç¤ºä¿¡æ¯ */
    .toast {
      position: fixed;
      bottom: 1.2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #8B4513;
      color: white;
      padding: 0.6rem 1.5rem;
      border-radius: 1.5rem;
      font-size: 0.85rem;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
    }

    /* é€‰ä¸­æç¤º */
    .selection-hint {
      font-size: 0.7rem;
      color: #8B4513;
      text-align: center;
      margin-bottom: 0.5rem;
      padding: 0.25rem;
      background: rgba(245, 222, 179, 0.5);
      border-radius: 0.3rem;
    }

    /* æ°´äº• */
    .well-box {
      background: #E0F7FA;
      border-radius: 0.6rem;
      padding: 0.6rem;
      margin-bottom: 0.75rem;
      text-align: center;
      border: 0.12rem solid #4DD0E1;
    }

    .well-title {
      font-size: 0.8rem;
      color: #00838F;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    .well-btn {
      padding: 0.5rem 1.2rem;
      background: #4DD0E1;
      border: none;
      border-radius: 1.2rem;
      cursor: pointer;
      font-weight: bold;
      color: white;
      font-size: 0.85rem;
      transition: all 0.3s;
    }

    .well-btn:hover {
      background: #26C6DA;
      transform: scale(1.05);
    }

    .well-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .well-progress {
      width: 100%;
      height: 0.4rem;
      background: #B2EBF2;
      border-radius: 0.18rem;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .well-progress-fill {
      height: 100%;
      background: #00BCD4;
      border-radius: 0.18rem;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <div class="header">
    <div class="header-item">
      <span>ğŸ’°</span>
      <span id="gold-display">100</span>
    </div>
    <div class="header-item">
      <span>ğŸ†</span>
      <span>ç¬¬ <span id="round-display">1</span> å±€</span>
    </div>
    <div class="timer">
      â±ï¸ <span id="time-display">5:00</span>
    </div>
    <div class="header-item">
      <button id="save-btn" style="padding:0.25rem 0.75rem;border-radius:0.5rem;background:#FFD700;color:#8B4513;font-weight:bold;border:none;cursor:pointer;margin-right:0.4rem;font-size:0.85rem;" onclick="saveGameWithUser()">å­˜æ¡£</button>
      <button id="load-btn" style="padding:0.25rem 0.75rem;border-radius:0.5rem;background:#90EE90;color:#2E8B57;font-weight:bold;border:none;cursor:pointer;font-size:0.85rem;" onclick="showLoadDialog()">è¯»æ¡£</button>
    </div>
  </div>

  <!-- ä¸»æ¸¸æˆåŒº -->
  <div id="game">
    <!-- å†œç”°åŒº -->
    <div class="field">
      <div class="section-title">ğŸŒ¾ å†œç”°åŒº</div>
      <div class="selection-hint">ç‚¹å‡»é€‰æ‹©ä½œç‰©ï¼Œå†ç‚¹å‡»ç©ºåœ°ç§æ¤ï¼ˆæ— é™ï¼‰</div>
      <div class="seeds-bar" id="seeds-bar">
        <!-- ç§å­æ åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="farm-grid" id="farm-grid">
        <!-- å†œç”°æ ¼å­åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- åˆ¶ä½œåŒº -->
    <div class="kitchen">
      <div class="section-title">ğŸ‘¨â€ğŸ³ åˆ¶ä½œåŒº</div>
      
      <!-- æ°´äº• -->
      <div class="well-box">
        <div class="well-title">ğŸš° æ°´äº•ï¼ˆå…è´¹å–æ°´ï¼‰</div>
        <button class="well-btn" id="well-btn" onclick="fetchWater()">æ‰“æ°´</button>
        <div class="well-progress" id="well-progress" style="display:none;">
          <div class="well-progress-fill" id="well-progress-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="inventory-box">
        <div class="inventory-title">ğŸ“¦ åŸæ–™ä»“åº“ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>
        <div class="inventory-items" id="inventory-items">
          <div style="color: #999; font-size: 0.75rem;">æš‚æ— åŸæ–™</div>
        </div>
      </div>
      
      <div class="recipes-box">
        <div class="inventory-title">ğŸ“– é…æ–¹ä¹¦ï¼ˆç‚¹å‡»åˆ¶ä½œï¼‰</div>
        <div id="recipes-list">
          <!-- é…æ–¹åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <div class="crafting-queue">
        <div class="inventory-title">â³ åˆ¶ä½œä¸­</div>
        <div id="crafting-list">
          <div style="color: #999; font-size: 0.75rem;">æš‚æ— åˆ¶ä½œä¸­çš„ç‰©å“</div>
        </div>
      </div>
    </div>

    <!-- å¸‚åœºåŒº -->
    <div class="market">
      <div class="section-title">ğŸª å¸‚åœºï¼ˆè´­ä¹°åŸæ–™ï¼‰</div>
      <div class="selection-hint">èŠ±é’±è´­ä¹°åŸæ–™ï¼Œçœæ—¶çœåŠ›</div>
      <div class="market-items" id="market-items">
        <!-- å¸‚åœºç‰©å“åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- å”®å–åŒº -->
    <div class="shop">
      <div class="section-title">ğŸ’° å”®å–åŒº</div>
      
      <div class="counter-box">
        <div class="inventory-title">ğŸ¥ æŸœå°ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>
        <div class="counter-items" id="counter-items">
          <div style="color: #999; font-size: 0.75rem; width: 100%; text-align: center;">æš‚æ— é¢åŒ…</div>
        </div>
      </div>
      
      <div class="customers-box">
        <div class="inventory-title">ğŸ‘¥ é¡¾å®¢ï¼ˆç‚¹å‡»å‡ºå”®ï¼‰</div>
        <div id="customers-list">
          <div style="color: #999; font-size: 0.75rem; text-align: center; padding: 0.9rem;">ç­‰å¾…é¡¾å®¢å…‰ä¸´...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
  <div class="modal-overlay" id="game-over-modal">
    <div class="modal">
      <div class="modal-title">ğŸ‰ æœ¬å±€ç»“æŸï¼</div>
      <div class="modal-content">
        <div class="modal-stats">
          <div class="stat-row">
            <span>â±ï¸ æ¸¸æˆæ—¶é•¿</span>
            <span>5:00</span>
          </div>
          <div class="stat-row">
            <span>ğŸ’° æœ¬å±€æ”¶ç›Š</span>
            <span id="round-gold">0</span>
          </div>
          <div class="stat-row">
            <span>ğŸ å”®å‡ºé¢åŒ…</span>
            <span id="round-breads">0</span>
          </div>
          <div class="stat-row">
            <span>ğŸ’µ æ€»é‡‘å¸</span>
            <span id="total-gold">0</span>
          </div>
        </div>
      </div>
      <button class="modal-btn" onclick="nextRound()">ä¸‹ä¸€å±€ â†’</button>
    </div>
  </div>

  <!-- å‡çº§å•†åº—å¼¹çª— -->
  <div class="modal-overlay" id="upgrade-modal">
    <div class="modal">
      <div class="modal-title">ğŸª å‡çº§å•†åº—</div>
      <div class="modal-content">
        ç”¨é‡‘å¸è´­ä¹°æ°¸ä¹…å‡çº§ï¼Œè®©ä¸‹ä¸€å±€æ›´è½»æ¾ï¼
      </div>
      <div class="upgrade-shop" id="upgrade-shop">
        <!-- å‡çº§é¡¹åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <button class="modal-btn" onclick="startNextRound()">å¼€å§‹ä¸‹ä¸€å±€</button>
    </div>
  </div>

  <!-- æç¤ºä¿¡æ¯ -->
  <div class="toast" id="toast"></div>

  <script>
    // ==================== æ¸¸æˆé…ç½® ====================
    // ========== å¤šç”¨æˆ·å¤šå…³å¡å­˜æ¡£åŠŸèƒ½ ==========
    function saveGameWithUser() {
      // å¼¹å‡ºè‡ªå®šä¹‰ç”¨æˆ·åè¾“å…¥æ¡†
      showUsernameModal(function(username) {
        if (!username) { showToast('æœªè¾“å…¥ç”¨æˆ·åï¼Œå­˜æ¡£å–æ¶ˆ'); return; }
        localStorage.setItem('bakery_last_user', username);
        const now = new Date();
        const saveTime = now.toLocaleString();
        const saveObj = {
          username,
          time: saveTime,
          round: state.round,
          state: JSON.parse(JSON.stringify(state))
        };
        // è¿½åŠ åˆ°å­˜æ¡£åˆ—è¡¨
        let saves = [];
        try { saves = JSON.parse(localStorage.getItem('bakery_saves')||'[]'); } catch {}
        saves.push(saveObj);
        localStorage.setItem('bakery_saves', JSON.stringify(saves));
        showToast('å­˜æ¡£æˆåŠŸï¼ç”¨æˆ·åï¼š' + username + 'ï¼Œç¬¬' + state.round + 'å…³');
      });
    }

    // ç¾è§‚çš„ç”¨æˆ·åè¾“å…¥æ¨¡æ€æ¡†
    function showUsernameModal(onSubmit) {
      let lastUser = localStorage.getItem('bakery_last_user') || '';
      // é¿å…é‡å¤å¼¹å‡º
      if (document.getElementById('username-modal-bg')) return;
      let html = `<div class="modal-overlay active" id="username-modal-bg" style="z-index:2001;">
        <div class="modal">
          <div class="modal-title">è¯·è¾“å…¥ç”¨æˆ·å</div>
          <div class="modal-content">
            <input id="username-input" type="text" value="${lastUser.replace(/"/g,'&quot;')}" placeholder="ç”¨æˆ·å" style="width:80%;padding:0.5rem 0.75rem;font-size:1rem;border-radius:0.5rem;border:0.06rem solid #DEB887;outline:none;" maxlength="16" autofocus />
          </div>
          <div style="margin-top:0.6rem;">
            <button class="modal-btn" id="username-ok-btn">ç¡®å®š</button>
            <button class="modal-btn" style="background:#ccc;color:#333;margin-left:0.75rem;" id="username-cancel-btn">å–æ¶ˆ</button>
          </div>
        </div>
      </div>`;
      const modal = document.createElement('div');
      modal.innerHTML = html;
      document.body.appendChild(modal);
      // äº‹ä»¶ç»‘å®š
      setTimeout(()=>{
        document.getElementById('username-input').focus();
      }, 100);
      document.getElementById('username-ok-btn').onclick = function() {
        const val = document.getElementById('username-input').value.trim();
        closeUsernameModal();
        onSubmit(val);
      };
      document.getElementById('username-cancel-btn').onclick = function() {
        closeUsernameModal();
        onSubmit(null);
      };
      document.getElementById('username-input').onkeydown = function(e) {
        if (e.key === 'Enter') document.getElementById('username-ok-btn').click();
      };
      window.closeUsernameModal = function() {
        if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
      };
    }

    function showLoadDialog() {
      let saves = [];
      try { saves = JSON.parse(localStorage.getItem('bakery_saves')||'[]'); } catch {}
      if (!saves.length) { showToast('æ²¡æœ‰å¯ç”¨å­˜æ¡£'); return; }
      // æ„å»ºé€‰æ‹©æ¡†
      let html = '<div id="load-modal-bg" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;">';
      html += '<div style="background:#fff;padding:1.5rem 1.1rem;border-radius:1rem;min-width:16rem;max-width:90vw;max-height:80vh;overflow:auto;">';
      html += '<div style="font-size:1.1rem;font-weight:bold;color:#8B4513;margin-bottom:0.6rem;">é€‰æ‹©å­˜æ¡£</div>';
      html += '<table style="width:100%;font-size:0.85rem;margin-bottom:0.6rem;">';
      html += '<tr><th>ç”¨æˆ·å</th><th>å…³å¡</th><th>æ—¶é—´</th><th></th></tr>';
      saves.forEach((s, i) => {
        html += `<tr><td>${s.username}</td><td>${s.round}</td><td>${s.time}</td><td><button onclick="loadGameFromList(${i})" style='padding:0.12rem 0.5rem;border-radius:0.4rem;background:#90EE90;color:#2E8B57;border:none;cursor:pointer;font-size:0.75rem;'>è¯»æ¡£</button></td></tr>`;
      });
      html += '</table>';
      html += '<button onclick="closeLoadModal()" style="padding:0.4rem 1.1rem;border-radius:0.5rem;background:#ccc;color:#333;border:none;cursor:pointer;font-size:0.85rem;">å–æ¶ˆ</button>';
      html += '</div></div>';
      const modal = document.createElement('div');
      modal.innerHTML = html;
      document.body.appendChild(modal);
      window.closeLoadModal = function() { document.body.removeChild(modal); };
    }

    function loadGameFromList(idx) {
      let saves = [];
      try { saves = JSON.parse(localStorage.getItem('bakery_saves')||'[]'); } catch {}
      if (!saves[idx]) { showToast('å­˜æ¡£ä¸å­˜åœ¨'); return; }
      const save = saves[idx];
      // æ¢å¤åˆ°è¯¥å…³å¡æœªå¼€å§‹çŠ¶æ€
      restoreGameToRoundStart(save.state, save.round);
      closeLoadModal();
      showToast('å·²è¯»æ¡£ï¼š' + save.username + ' ç¬¬' + save.round + 'å…³');
    }
    window.showLoadDialog = showLoadDialog;
    window.loadGameFromList = loadGameFromList;

    function restoreGameToRoundStart(savedState, round) {
      // åªæ¢å¤æ°¸ä¹…å‡çº§ã€é‡‘å¸ã€å…³å¡æ•°ï¼Œé‡ç½®æœ¬å±€çŠ¶æ€
      state.gold = savedState.gold;
      state.round = round;
      state.permanent = JSON.parse(JSON.stringify(savedState.permanent));
      // é‡ç½®æœ¬å±€çŠ¶æ€
      state.time = 300;
      state.isPlaying = true;
      state.crops = [];
      state.inventory = {};
      state.crafting = [];
      state.counter = {};
      state.customers = [];
      state.well = { fetching: false, finishTime: 0 };
      state.selectedSeed = null;
      state.selectedIngredient = null;
      state.selectedBread = null;
      state.stats = { breadsSold: 0, goldEarned: 0 };
      updateUI();
      updateTimer();
      startGameLoop();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ä»æœ€æ–°å­˜æ¡£æ¢å¤
    function tryAutoLoad() {
      let saves = [];
      try { saves = JSON.parse(localStorage.getItem('bakery_saves')||'[]'); } catch {}
      if (saves.length) {
        const save = saves[saves.length-1];
        restoreGameToRoundStart(save.state, save.round);
        showToast('å·²è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡å­˜æ¡£ï¼š' + save.username + ' ç¬¬' + save.round + 'å…³');
      }
    }
    const CROP_DATA = {
      wheat: { name: 'å°éº¦', emoji: 'ğŸŒ¾', growTime: 5, output: 'flour', outputCount: 2 },
      cow: { name: 'å¥¶ç‰›', emoji: 'ğŸ„', growTime: 10, output: 'milk', outputCount: 1 },
      sugarcane: { name: 'ç”˜è”—', emoji: 'ğŸ‹', growTime: 8, output: 'sugar', outputCount: 1 },
      chicken: { name: 'æ¯é¸¡', emoji: 'ğŸ”', growTime: 12, output: 'egg', outputCount: 1 }
    };

    const ITEM_DATA = {
      flour: { name: 'é¢ç²‰', emoji: 'ğŸŒ¾' },
      milk: { name: 'ç‰›å¥¶', emoji: 'ğŸ¥›' },
      sugar: { name: 'ç³–', emoji: 'ğŸ¬' },
      egg: { name: 'é¸¡è›‹', emoji: 'ğŸ¥š' },
      water: { name: 'æ°´', emoji: 'ğŸ’§' },
      dough: { name: 'é¢å›¢', emoji: 'ğŸ¥Ÿ' },
      butter_dough: { name: 'é»„æ²¹é¢å›¢', emoji: 'ğŸ§ˆ' },
      cake_batter: { name: 'è›‹ç³•ç³Š', emoji: 'ğŸ¥£' },
      white_bread: { name: 'ç™½é¢åŒ…', emoji: 'ğŸ', price: 20 },
      butter_bread: { name: 'é»„æ²¹é¢åŒ…', emoji: 'ğŸ¥', price: 50 },
      sweet_bread: { name: 'ç”œé¢åŒ…', emoji: 'ğŸ¥–', price: 80 },
      cake: { name: 'è›‹ç³•', emoji: 'ğŸ°', price: 150 }
    };

    const RECIPES = [
      { id: 'dough', name: 'é¢å›¢', ingredients: ['flour', 'water'], time: 1, output: 'dough' },
      { id: 'white_bread', name: 'ç™½é¢åŒ…', ingredients: ['dough'], time: 2, output: 'white_bread' },
      { id: 'butter_dough', name: 'é»„æ²¹é¢å›¢', ingredients: ['dough', 'milk'], time: 2, output: 'butter_dough' },
      { id: 'butter_bread', name: 'é»„æ²¹é¢åŒ…', ingredients: ['butter_dough'], time: 3, output: 'butter_bread' },
      { id: 'cake_batter', name: 'è›‹ç³•ç³Š', ingredients: ['dough', 'sugar', 'egg'], time: 3, output: 'cake_batter' },
      { id: 'cake', name: 'è›‹ç³•', ingredients: ['cake_batter'], time: 5, output: 'cake' }
    ];

    const MARKET_ITEMS = [
      { id: 'flour', name: 'é¢ç²‰', emoji: 'ğŸŒ¾', price: 5, desc: 'åˆ¶ä½œé¢å›¢å¿…å¤‡' },
      { id: 'water', name: 'æ°´', emoji: 'ğŸ’§', price: 3, desc: 'åˆ¶ä½œé¢å›¢å¿…å¤‡' },
      { id: 'milk', name: 'ç‰›å¥¶', emoji: 'ğŸ¥›', price: 10, desc: 'åˆ¶ä½œé»„æ²¹é¢åŒ…' },
      { id: 'sugar', name: 'ç³–', emoji: 'ğŸ¬', price: 8, desc: 'åˆ¶ä½œè›‹ç³•' },
      { id: 'egg', name: 'é¸¡è›‹', emoji: 'ğŸ¥š', price: 12, desc: 'åˆ¶ä½œè›‹ç³•' }
    ];

    const UPGRADES = [
      { id: 'grow_speed', name: 'ç”Ÿé•¿åŠ é€Ÿ', emoji: 'âš¡', desc: 'æ‰€æœ‰ä½œç‰©ç”Ÿé•¿æ—¶é—´-20%', price: 1000, effect: () => { state.permanent.growSpeed *= 0.8; } },
      { id: 'craft_speed', name: 'åˆ¶ä½œåŠ é€Ÿ', emoji: 'ğŸ”¥', desc: 'åˆ¶ä½œæ—¶é—´-20%', price: 1500, effect: () => { state.permanent.craftSpeed *= 0.8; } },
      { id: 'well_speed', name: 'æ°´äº•åŠ é€Ÿ', emoji: 'ğŸš°', desc: 'æ‰“æ°´æ—¶é—´-30%', price: 800, effect: () => { state.permanent.wellSpeed *= 0.7; } },
      { id: 'unlock_cow', name: 'è§£é”å¥¶ç‰›', emoji: 'ğŸ„', desc: 'å±€å†…å¯ç§æ¤å¥¶ç‰›', price: 200, effect: () => { state.permanent.unlockedCrops.push('cow'); } },
      { id: 'unlock_sugarcane', name: 'è§£é”ç”˜è”—', emoji: 'ğŸ‹', desc: 'å±€å†…å¯ç§æ¤ç”˜è”—', price: 800, effect: () => { state.permanent.unlockedCrops.push('sugarcane'); } },
      { id: 'unlock_chicken', name: 'è§£é”æ¯é¸¡', emoji: 'ğŸ”', desc: 'å±€å†…å¯ç§æ¤æ¯é¸¡', price: 1500, effect: () => { state.permanent.unlockedCrops.push('chicken'); } }
    ];

    const CUSTOMER_TYPES = [
      { emoji: 'ğŸ‘¨', names: ['å¼ å…ˆç”Ÿ', 'æå…ˆç”Ÿ', 'ç‹å…ˆç”Ÿ'] },
      { emoji: 'ğŸ‘©', names: ['å¼ å¥³å£«', 'æå¥³å£«', 'ç‹å¥³å£«'] },
      { emoji: 'ğŸ‘´', names: ['è€çˆ·çˆ·', 'è€å¤§çˆ·'] },
      { emoji: 'ğŸ‘µ', names: ['è€å¥¶å¥¶', 'è€å¤§å¨˜'] },
      { emoji: 'ğŸ‘¦', names: ['å°æ˜', 'å°åˆš', 'å°å¼º'] },
      { emoji: 'ğŸ‘§', names: ['å°çº¢', 'å°ä¸½', 'å°ç¾'] }
    ];

    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    const state = {
      gold: 100,
      round: 1,
      time: 300,
      isPlaying: false,
      
      // æ°¸ä¹…å‡çº§
      permanent: {
        growSpeed: 1,
        craftSpeed: 1,
        wellSpeed: 1,
        unlockedCrops: ['wheat', 'cow', 'sugarcane', 'chicken']
      },
      
      // æœ¬å±€çŠ¶æ€
      crops: [],
      inventory: {},
      crafting: [],
      counter: {},
      customers: [],
      
      // æ°´äº•çŠ¶æ€
      well: {
        fetching: false,
        finishTime: 0
      },
      
      // é€‰ä¸­çŠ¶æ€
      selectedSeed: null,
      selectedIngredient: null,
      selectedBread: null,
      
      // ç»Ÿè®¡
      stats: {
        breadsSold: 0,
        goldEarned: 0
      }
    };

    // ==================== åˆå§‹åŒ– ====================
    function init() {
      // åˆå§‹åŒ–å†œç”°æ ¼å­ (9æ ¼)
      const farmGrid = document.getElementById('farm-grid');
      farmGrid.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const plot = document.createElement('div');
        plot.className = 'farm-plot';
        plot.dataset.index = i;
        plot.onclick = () => onPlotClick(i);
        farmGrid.appendChild(plot);
      }
      
      startNewRound();
    }

    function startNewRound() {
      // é‡ç½®æœ¬å±€çŠ¶æ€
      state.time = 300;
      state.isPlaying = true;
      state.crops = [];
      state.inventory = {};
      state.crafting = [];
      state.counter = {};
      state.customers = [];
      state.well = { fetching: false, finishTime: 0 };
      state.selectedSeed = null;
      state.selectedIngredient = null;
      state.selectedBread = null;
      state.stats = { breadsSold: 0, goldEarned: 0 };
      
      // æ›´æ–°UI
      updateUI();
      
      // å…³é—­å¼¹çª—
      document.getElementById('game-over-modal').classList.remove('active');
      document.getElementById('upgrade-modal').classList.remove('active');
      
      // å¼€å§‹æ¸¸æˆå¾ªç¯
      startGameLoop();
      
      showToast('ç¬¬ ' + state.round + ' å±€å¼€å§‹ï¼ç§æ¤å°éº¦â†’æ‰“æ°´â†’åšé¢å›¢â†’çƒ¤é¢åŒ…ï¼');
    }

    // ==================== æ¸¸æˆå¾ªç¯ ====================
    let gameInterval;
    let customerInterval;
    
    function startGameLoop() {
      clearInterval(gameInterval);
      clearInterval(customerInterval);
      
      gameInterval = setInterval(() => {
        if (!state.isPlaying) return;
        
        state.time--;
        if (state.time <= 0) {
          endGame();
          return;
        }
        
        // æ›´æ–°ä½œç‰©
        updateCrops();
        
        // æ›´æ–°æ°´äº•
        updateWell();
        
        // æ›´æ–°åˆ¶ä½œ
        updateCrafting();
        
        // æ›´æ–°é¡¾å®¢è€å¿ƒ
        updateCustomers();
        
        // æ›´æ–°UI
        updateTimer();
      }, 1000);
      
      // é¡¾å®¢ç”Ÿæˆ
      customerInterval = setInterval(() => {
        if (!state.isPlaying) return;
        if (state.customers.length < 5) {
          spawnCustomer();
        }
      }, 3000 + Math.random() * 5000);
    }

    // ==================== æ°´äº•ç³»ç»Ÿ ====================
    function fetchWater() {
      if (state.well.fetching) return;
      
      const fetchTime = Math.floor(3 * state.permanent.wellSpeed);
      state.well.fetching = true;
      state.well.finishTime = Date.now() + fetchTime * 1000;
      
      document.getElementById('well-btn').disabled = true;
      document.getElementById('well-btn').textContent = 'æ‰“æ°´ä¸­...';
      document.getElementById('well-progress').style.display = 'block';
      
      showToast('å¼€å§‹æ‰“æ°´ï¼Œéœ€è¦ ' + fetchTime + ' ç§’...');
    }

    function updateWell() {
      if (!state.well.fetching) return;
      
      const now = Date.now();
      const progress = (now - (state.well.finishTime - 3000 * state.permanent.wellSpeed)) / (3000 * state.permanent.wellSpeed);
      const percent = Math.min(100, Math.floor(progress * 100));
      
      document.getElementById('well-progress-fill').style.width = percent + '%';
      
      if (now >= state.well.finishTime) {
        // æ‰“æ°´å®Œæˆ
        state.well.fetching = false;
        state.inventory.water = (state.inventory.water || 0) + 1;
        
        document.getElementById('well-btn').disabled = false;
        document.getElementById('well-btn').textContent = 'æ‰“æ°´';
        document.getElementById('well-progress').style.display = 'none';
        document.getElementById('well-progress-fill').style.width = '0%';
        
        updateInventory();
        updateRecipes();
        showToast('è·å¾— 1 ä¸ªæ°´ï¼');
      }
    }

    // ==================== å†œç”°ç³»ç»Ÿ ====================
    function updateSeedsBar() {
      const seedsBar = document.getElementById('seeds-bar');
      seedsBar.innerHTML = '';
      
      for (const [type, data] of Object.entries(CROP_DATA)) {
        const seedItem = document.createElement('div');
        seedItem.className = 'seed-item' + (state.selectedSeed === type ? ' selected' : '');
        
        const isUnlocked = state.permanent.unlockedCrops.includes(type);
        if (!isUnlocked) seedItem.classList.add('locked');
        
        seedItem.innerHTML = `
          <span>${data.emoji}</span>
          <span>${data.name}</span>
          <span class="unlimited">âˆ</span>
        `;
        
        if (isUnlocked) {
          seedItem.onclick = () => selectSeed(type);
        }
        
        seedsBar.appendChild(seedItem);
      }
    }

    function selectSeed(type) {
      state.selectedSeed = state.selectedSeed === type ? null : type;
      state.selectedIngredient = null;
      state.selectedBread = null;
      updateSeedsBar();
      showToast('å·²é€‰æ‹© ' + CROP_DATA[type].name + 'ï¼ˆæ— é™ï¼‰ï¼Œç‚¹å‡»ç©ºåœ°ç§æ¤');
    }

    function onPlotClick(index) {
      const plot = state.crops[index];
      
      // æ”¶è·
      if (plot && plot.ready && !plot.harvested) {
        harvestCrop(index);
        return;
      }
      
      // ç§æ¤ï¼ˆæ— é™ç§å­ï¼‰
      if (!plot && state.selectedSeed) {
        plantCrop(index, state.selectedSeed);
      }
    }

    function plantCrop(index, type) {
      const data = CROP_DATA[type];
      const growTime = Math.floor(data.growTime * state.permanent.growSpeed);
      
      state.crops[index] = {
        type,
        plantTime: Date.now(),
        readyTime: Date.now() + growTime * 1000,
        ready: false,
        harvested: false
      };
      
      state.selectedSeed = null;
      updateSeedsBar();
      updateFarmGrid();
      showToast('ç§æ¤äº† ' + data.name + 'ï¼Œéœ€è¦ ' + growTime + ' ç§’æˆç†Ÿ');
    }

    function harvestCrop(index) {
      const crop = state.crops[index];
      const data = CROP_DATA[crop.type];
      
      crop.harvested = true;
      
      // æ·»åŠ åŸæ–™åˆ°ä»“åº“
      const output = data.output;
      state.inventory[output] = (state.inventory[output] || 0) + data.outputCount;
      
      updateFarmGrid();
      updateInventory();
      updateRecipes();
      showToast('æ”¶è·äº† ' + data.outputCount + ' ä¸ª' + ITEM_DATA[output].name + 'ï¼');
      
      // æ¸…ç©ºæ ¼å­
      setTimeout(() => {
        state.crops[index] = null;
        updateFarmGrid();
      }, 300);
    }

    function updateCrops() {
      const now = Date.now();
      let changed = false;
      
      state.crops.forEach(crop => {
        if (crop && !crop.ready && !crop.harvested && now >= crop.readyTime) {
          crop.ready = true;
          changed = true;
        }
      });
      
      if (changed) updateFarmGrid();
    }

    function updateFarmGrid() {
      const plots = document.querySelectorAll('.farm-plot');
      
      plots.forEach((plotEl, index) => {
        const crop = state.crops[index];
        plotEl.className = 'farm-plot';
        plotEl.innerHTML = '';
        
        if (!crop) {
        plotEl.innerHTML = '<span style="font-size:1.5rem;opacity:0.3;">ğŸŒ±</span>';
          return;
        }
        
        const data = CROP_DATA[crop.type];
        
        if (crop.harvested) {
          plotEl.innerHTML = '<span style="font-size:1.5rem;opacity:0.3;">âœ¨</span>';
        } else if (crop.ready) {
          plotEl.classList.add('planted', 'ready');
          plotEl.innerHTML = `
            <span class="crop-icon">${data.emoji}</span>
            <span class="plot-status">å¯æ”¶è·ï¼</span>
          `;
        } else {
          plotEl.classList.add('planted');
          const progress = (Date.now() - crop.plantTime) / (crop.readyTime - crop.plantTime);
          const percent = Math.min(100, Math.floor(progress * 100));
          plotEl.innerHTML = `
            <span class="crop-icon">ğŸŒ±</span>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percent}%"></div>
            </div>
            <span class="plot-status">${percent}%</span>
          `;
        }
      });
    }

    // ==================== å¸‚åœºç³»ç»Ÿ ====================
    function updateMarket() {
      const marketItems = document.getElementById('market-items');
      marketItems.innerHTML = '';
      
      MARKET_ITEMS.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'market-item';
        
        const canAfford = state.gold >= item.price;
        
        itemEl.innerHTML = `
          <div class="market-item-icon">${item.emoji}</div>
          <div class="market-item-info">
            <div class="market-item-name">${item.name}</div>
            <div class="market-item-desc">${item.desc}</div>
          </div>
          <button class="market-btn" ${!canAfford ? 'disabled' : ''} onclick="buyItem('${item.id}')">
            ğŸ’°${item.price}
          </button>
        `;
        
        marketItems.appendChild(itemEl);
      });
    }

    function buyItem(itemId) {
      const item = MARKET_ITEMS.find(i => i.id === itemId);
      if (!item || state.gold < item.price) {
        showToast('é‡‘å¸ä¸è¶³ï¼');
        return;
      }
      
      state.gold -= item.price;
      state.inventory[itemId] = (state.inventory[itemId] || 0) + 1;
      
      updateHeader();
      updateMarket();
      updateInventory();
      updateRecipes();
      showToast('è´­ä¹°äº† 1 ä¸ª' + item.name + 'ï¼');
    }

    // ==================== åˆ¶ä½œç³»ç»Ÿ ====================
    function updateInventory() {
      const invItems = document.getElementById('inventory-items');
      
      const hasItems = Object.keys(state.inventory).length > 0;
      if (!hasItems) {
        invItems.innerHTML = '<div style="color: #999; font-size: 0.75rem;">æš‚æ— åŸæ–™ï¼Œå»æ‰“æ°´æˆ–å»å¸‚åœºè´­ä¹°</div>';
        return;
      }
      
      invItems.innerHTML = '';
      for (const [item, count] of Object.entries(state.inventory)) {
        if (count <= 0) continue;
        
        const itemEl = document.createElement('div');
        itemEl.className = 'inv-item' + (state.selectedIngredient === item ? ' selected' : '');
        itemEl.innerHTML = `
          <span>${ITEM_DATA[item].emoji}</span>
          <span class="count">${count}</span>
        `;
        itemEl.onclick = () => selectIngredient(item);
        itemEl.title = ITEM_DATA[item].name;
        invItems.appendChild(itemEl);
      }
    }

    function selectIngredient(item) {
      state.selectedIngredient = state.selectedIngredient === item ? null : item;
      state.selectedSeed = null;
      state.selectedBread = null;
      updateInventory();
      updateRecipes();
      showToast('å·²é€‰æ‹© ' + ITEM_DATA[item].name);
    }

    function updateRecipes() {
      const recipesList = document.getElementById('recipes-list');
      recipesList.innerHTML = '';
      
      RECIPES.forEach(recipe => {
        const recipeEl = document.createElement('div');
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ¶ä½œ
        const canCraft = recipe.ingredients.every(ing => 
          (state.inventory[ing] || 0) > 0
        );
        
        recipeEl.className = 'recipe-item' + (canCraft ? ' can-craft' : '');
        
        const ingHtml = recipe.ingredients.map(ing => 
          `<span class="recipe-ing">${ITEM_DATA[ing].emoji}</span>`
        ).join('');
        
        const time = Math.floor(recipe.time * state.permanent.craftSpeed);
        
        recipeEl.innerHTML = `
          <div class="recipe-ingredients">${ingHtml}</div>
          <span class="recipe-arrow">â†’</span>
          <span class="recipe-result">${ITEM_DATA[recipe.output].emoji}</span>
          <span class="recipe-time">${time}ç§’</span>
        `;
        
        recipeEl.onclick = () => startCrafting(recipe);
        recipesList.appendChild(recipeEl);
      });
    }

    function startCrafting(recipe) {
      // æ£€æŸ¥åŸæ–™
      const hasIngredients = recipe.ingredients.every(ing => 
        (state.inventory[ing] || 0) > 0
      );
      
      if (!hasIngredients) {
        showToast('åŸæ–™ä¸è¶³ï¼');
        return;
      }
      
      // æ¶ˆè€—åŸæ–™
      recipe.ingredients.forEach(ing => {
        state.inventory[ing]--;
        if (state.inventory[ing] <= 0) delete state.inventory[ing];
      });
      
      // å¼€å§‹åˆ¶ä½œ
      const craftTime = Math.floor(recipe.time * state.permanent.craftSpeed);
      state.crafting.push({
        recipe,
        startTime: Date.now(),
        finishTime: Date.now() + craftTime * 1000,
        finished: false
      });
      
      state.selectedIngredient = null;
      updateInventory();
      updateRecipes();
      updateCraftingList();
      showToast('å¼€å§‹åˆ¶ä½œ ' + recipe.name + '...');
    }

    function updateCrafting() {
      const now = Date.now();
      let changed = false;
      
      state.crafting.forEach(craft => {
        if (!craft.finished && now >= craft.finishTime) {
          craft.finished = true;
          
          // äº§å‡º
          const output = craft.recipe.output;
          if (['white_bread', 'butter_bread', 'sweet_bread', 'cake'].includes(output)) {
            // é¢åŒ…æ”¾åˆ°æŸœå°
            state.counter[output] = (state.counter[output] || 0) + 1;
            updateCounter();
          } else {
            // åŠæˆå“æ”¾åˆ°ä»“åº“
            state.inventory[output] = (state.inventory[output] || 0) + 1;
            updateInventory();
          }
          
          changed = true;
          showToast(ITEM_DATA[output].name + ' åˆ¶ä½œå®Œæˆï¼');
        }
      });
      
      // æ¸…ç†å·²å®Œæˆçš„
      state.crafting = state.crafting.filter(c => !c.finished);
      if (changed || state.crafting.length === 0) {
        updateCraftingList();
      }
    }

    function updateCraftingList() {
      const craftingList = document.getElementById('crafting-list');
      
      if (state.crafting.length === 0) {
        craftingList.innerHTML = '<div style="color: #999; font-size: 0.75rem;">æš‚æ— åˆ¶ä½œä¸­çš„ç‰©å“</div>';
        return;
      }
      
      craftingList.innerHTML = '';
      const now = Date.now();
      
      state.crafting.forEach(craft => {
        const recipe = craft.recipe;
        const progress = (now - craft.startTime) / (craft.finishTime - craft.startTime);
        const percent = Math.min(100, Math.floor(progress * 100));
        
        const craftEl = document.createElement('div');
        craftEl.className = 'crafting-item';
        craftEl.innerHTML = `
          <span style="font-size:1.25rem;">${ITEM_DATA[recipe.output].emoji}</span>
          <div class="crafting-progress">
            <div class="crafting-fill" style="width: ${percent}%"></div>
          </div>
          <span style="font-size:0.7rem;color:#666;">${percent}%</span>
        `;
        craftingList.appendChild(craftEl);
      });
    }

    // ==================== å”®å–ç³»ç»Ÿ ====================
    function updateCounter() {
      const counterItems = document.getElementById('counter-items');
      
      const hasBreads = Object.keys(state.counter).length > 0;
      if (!hasBreads) {
        counterItems.innerHTML = '<div style="color: #999; font-size: 0.75rem; width: 100%; text-align: center;">æš‚æ— é¢åŒ…ï¼Œå¿«å»åˆ¶ä½œå§ï¼</div>';
        return;
      }
      
      counterItems.innerHTML = '';
      for (const [bread, count] of Object.entries(state.counter)) {
        if (count <= 0) continue;
        
        const itemEl = document.createElement('div');
        itemEl.className = 'counter-item' + (state.selectedBread === bread ? ' selected' : '');
        itemEl.innerHTML = `
          <span class="bread-icon">${ITEM_DATA[bread].emoji}</span>
          <span class="bread-price">ğŸ’°${ITEM_DATA[bread].price}</span>
          <span class="count">${count}</span>
        `;
        itemEl.onclick = () => selectBread(bread);
        counterItems.appendChild(itemEl);
      }
    }

    function selectBread(bread) {
      state.selectedBread = state.selectedBread === bread ? null : bread;
      state.selectedSeed = null;
      state.selectedIngredient = null;
      updateCounter();
      showToast('å·²é€‰æ‹© ' + ITEM_DATA[bread].name + 'ï¼Œç‚¹å‡»é¡¾å®¢å‡ºå”®');
    }

    function spawnCustomer() {
      const types = CUSTOMER_TYPES;
      const type = types[Math.floor(Math.random() * types.length)];
      const name = type.names[Math.floor(Math.random() * type.names.length)];
      
      // æ ¹æ®è¿›åº¦å†³å®šéœ€æ±‚
      let possibleWants = ['white_bread'];
      if (state.permanent.unlockedCrops.includes('cow')) possibleWants.push('butter_bread');
      if (state.permanent.unlockedCrops.includes('sugarcane')) possibleWants.push('sweet_bread');
      if (state.permanent.unlockedCrops.includes('chicken')) possibleWants.push('cake');
      
      const want = possibleWants[Math.floor(Math.random() * possibleWants.length)];
      
      const customer = {
        id: Date.now() + Math.random(),
        emoji: type.emoji,
        name,
        want,
        patience: 30
      };
      
      state.customers.push(customer);
      updateCustomersList();
    }

    function updateCustomers() {
      let changed = false;
      
      state.customers = state.customers.filter(c => {
        c.patience--;
        if (c.patience <= 0) changed = true;
        return c.patience > 0;
      });
      
      if (changed) updateCustomersList();
    }

    function updateCustomersList() {
      const customersList = document.getElementById('customers-list');
      
      if (state.customers.length === 0) {
        customersList.innerHTML = '<div style="color: #999; font-size: 0.75rem; text-align: center; padding: 0.9rem;">ç­‰å¾…é¡¾å®¢å…‰ä¸´...</div>';
        return;
      }
      
      customersList.innerHTML = '';
      
      state.customers.forEach(customer => {
        const customerEl = document.createElement('div');
        customerEl.className = 'customer';
        
        const wantItem = ITEM_DATA[customer.want];
        const hasBread = (state.counter[customer.want] || 0) > 0;
        
        customerEl.innerHTML = `
          <div class="customer-avatar">${customer.emoji}</div>
          <div class="customer-info">
            <div class="customer-name">${customer.name}</div>
            <div class="customer-want">
              æƒ³è¦: <span class="customer-want-emoji">${wantItem.emoji}</span>
              <span style="color:#8B4513;font-weight:bold;">ğŸ’°${wantItem.price}</span>
            </div>
          </div>
          <button class="customer-btn" ${!hasBread ? 'disabled' : ''} onclick="sellBread('${customer.id}')">
            ${hasBread ? 'å‡ºå”®' : 'ç¼ºè´§'}
          </button>
        `;
        
        customersList.appendChild(customerEl);
      });
    }

    function sellBread(customerId) {
      const customer = state.customers.find(c => c.id == customerId);
      if (!customer) return;
      
      const want = customer.want;
      if ((state.counter[want] || 0) <= 0) {
        showToast('æŸœå°æ²¡æœ‰ ' + ITEM_DATA[want].name + 'ï¼');
        return;
      }
      
      // å‡ºå”®
      state.counter[want]--;
      if (state.counter[want] <= 0) delete state.counter[want];
      
      const price = ITEM_DATA[want].price;
      state.gold += price;
      state.stats.goldEarned += price;
      state.stats.breadsSold++;
      
      // ç§»é™¤é¡¾å®¢
      state.customers = state.customers.filter(c => c.id != customerId);
      
      state.selectedBread = null;
      updateCounter();
      updateCustomersList();
      updateHeader();
      updateMarket();
      showToast('å”®å‡º ' + ITEM_DATA[want].name + 'ï¼Œè·å¾— ğŸ’°' + price + 'ï¼');
    }

    // ==================== UIæ›´æ–° ====================
    function updateUI() {
      updateHeader();
      updateSeedsBar();
      updateFarmGrid();
      updateInventory();
      updateRecipes();
      updateCraftingList();
      updateMarket();
      updateCounter();
      updateCustomersList();
    }

    function updateHeader() {
      document.getElementById('gold-display').textContent = state.gold;
      document.getElementById('round-display').textContent = state.round;
    }

    function updateTimer() {
      const minutes = Math.floor(state.time / 60);
      const seconds = state.time % 60;
      document.getElementById('time-display').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // ==================== æ¸¸æˆç»“æŸ ====================
    function endGame() {
      state.isPlaying = false;
      clearInterval(gameInterval);
      clearInterval(customerInterval);
      
      document.getElementById('round-gold').textContent = state.stats.goldEarned;
      document.getElementById('round-breads').textContent = state.stats.breadsSold;
      document.getElementById('total-gold').textContent = state.gold;
      
      document.getElementById('game-over-modal').classList.add('active');
    }

    function nextRound() {
      document.getElementById('game-over-modal').classList.remove('active');
      document.getElementById('upgrade-modal').classList.add('active');
      updateUpgradeShop();
    }
    window.nextRound = nextRound;

    function updateUpgradeShop() {
      const shop = document.getElementById('upgrade-shop');
      shop.innerHTML = '';
      
      UPGRADES.forEach(upgrade => {
        const upgradeEl = document.createElement('div');
        upgradeEl.className = 'upgrade-item';
        
        const canAfford = state.gold >= upgrade.price;
        const isUnlocked = 
          (upgrade.id === 'unlock_cow' && state.permanent.unlockedCrops.includes('cow')) ||
          (upgrade.id === 'unlock_sugarcane' && state.permanent.unlockedCrops.includes('sugarcane')) ||
          (upgrade.id === 'unlock_chicken' && state.permanent.unlockedCrops.includes('chicken'));
        
        upgradeEl.innerHTML = `
          <div class="upgrade-icon">${upgrade.emoji}</div>
          <div class="upgrade-info">
            <div class="upgrade-name">${upgrade.name}</div>
            <div class="upgrade-desc">${upgrade.desc}</div>
          </div>
          <button class="upgrade-btn" ${!canAfford || isUnlocked ? 'disabled' : ''} onclick="buyUpgrade('${upgrade.id}')">
            ${isUnlocked ? 'å·²è§£é”' : 'ğŸ’°' + upgrade.price}
          </button>
        `;
        
        shop.appendChild(upgradeEl);
      });
    }

    function buyUpgrade(upgradeId) {
      const upgrade = UPGRADES.find(u => u.id === upgradeId);
      if (!upgrade || state.gold < upgrade.price) return;
      
      state.gold -= upgrade.price;
      upgrade.effect();
      
      updateHeader();
      updateUpgradeShop();
      showToast('è´­ä¹°äº† ' + upgrade.name + 'ï¼');
    }

    function startNextRound() {
      state.round++;
      startNewRound();
    }
    window.startNextRound = startNextRound;

    // ==================== å¯åŠ¨æ¸¸æˆ ====================
    window.onload = init;
    window.saveGameWithUser = saveGameWithUser;
    // è‡ªåŠ¨åŠ è½½å­˜æ¡£
    window.addEventListener('DOMContentLoaded', tryAutoLoad);
  </script>
</body>
</html>
